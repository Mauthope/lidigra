<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Instruções Passo a Passo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f7f7f7;
    }
    h1, h2 {
      color: #333;
    }
    input, textarea, button, select {
      width: 100%;
      margin: 5px 0 15px;
      padding: 10px;
      font-size: 1em;
    }
    .passo {
      background: #fff;
      padding: 15px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .passo img {
      max-width: 100%;
      height: auto;
      display: block;
      margin-top: 10px;
    }
    .botoes {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .instrucoes-salvas {
      margin-top: 30px;
    }
    .btn {
      background: #3498db;
      color: white;
      border: none;
      cursor: pointer;
    }
    .btn:hover {
      background: #2980b9;
    }
    .btn-danger {
      background: #e74c3c;
    }
    .btn-danger:hover {
      background: #c0392b;
    }
  </style>
</head>
<body>
  <h1>Criação de Instruções</h1>
  <input type="text" id="titulo" placeholder="Título da instrução">
  <textarea id="descricao" placeholder="Descrição geral da instrução"></textarea>

  <div id="passos-container"></div>

  <button class="btn" onclick="adicionarPasso()">Adicionar Passo</button>
  <button class="btn" onclick="salvarInstrucao()">Salvar Instrução</button>
  <button class="btn" onclick="exportarPDF()">Exportar em PDF</button>

  <div class="instrucoes-salvas">
    <h2>Instruções Salvas</h2>
    <select id="listaInstrucoes" onchange="carregarInstrucao(this.value)">
      <option value="">Selecione uma instrução</option>
    </select>
  </div>

  <!-- Biblioteca html2pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    let passos = [];

    function adicionarPasso() {
      const passoIndex = passos.length + 1;
      const div = document.createElement("div");
      div.className = "passo";
      div.innerHTML = `
        <strong>Passo ${passoIndex}</strong>
        <textarea placeholder="Descrição do passo"></textarea>
        <input type="file" accept="image/*" onchange="carregarImagem(this)">
        <img style="display:none">
        <button class="btn btn-danger" onclick="removerPasso(this)">Remover Passo</button>
      `;
      document.getElementById("passos-container").appendChild(div);
      passos.push(div);
    }

    function removerPasso(botao) {
      const div = botao.parentElement;
      div.remove();
      passos = Array.from(document.querySelectorAll('.passo'));
      passos.forEach((p, i) => {
        p.querySelector('strong').textContent = `Passo ${i + 1}`;
      });
    }

    function carregarImagem(input) {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const img = input.nextElementSibling;
          img.src = e.target.result;
          img.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    }

    function salvarInstrucao() {
      const titulo = document.getElementById("titulo").value.trim();
      if (!titulo) {
        alert("Informe um título para a instrução.");
        return;
      }
      const descricao = document.getElementById("descricao").value;
      const dados = {
        titulo,
        descricao,
        passos: []
      };
      document.querySelectorAll(".passo").forEach(p => {
        dados.passos.push({
          descricao: p.querySelector("textarea").value,
          imagem: p.querySelector("img").src || ""
        });
      });
      localStorage.setItem("instrucao_" + titulo, JSON.stringify(dados));
      carregarListaInstrucoes();
      alert("Instrução salva com sucesso.");
    }

    function carregarListaInstrucoes() {
      const select = document.getElementById("listaInstrucoes");
      select.innerHTML = '<option value="">Selecione uma instrução</option>';
      Object.keys(localStorage).filter(k => k.startsWith("instrucao_")).forEach(k => {
        const titulo = k.replace("instrucao_", "");
        const opt = document.createElement("option");
        opt.value = k;
        opt.textContent = titulo;
        select.appendChild(opt);
      });
    }

    function carregarInstrucao(chave) {
      if (!chave) return;
      const dados = JSON.parse(localStorage.getItem(chave));
      document.getElementById("titulo").value = dados.titulo;
      document.getElementById("descricao").value = dados.descricao;
      document.getElementById("passos-container").innerHTML = '';
      passos = [];
      dados.passos.forEach(p => {
        const div = document.createElement("div");
        div.className = "passo";
        div.innerHTML = `
          <strong>Passo ${passos.length + 1}</strong>
          <textarea>${p.descricao}</textarea>
          <input type="file" accept="image/*" onchange="carregarImagem(this)">
          <img src="${p.imagem}" style="${p.imagem ? 'display:block' : 'display:none'}">
          <button class="btn btn-danger" onclick="removerPasso(this)">Remover Passo</button>
        `;
        document.getElementById("passos-container").appendChild(div);
        passos.push(div);
      });
    }

    function exportarPDF() {
      const titulo = document.getElementById("titulo").value || "Instrução";
      const area = document.createElement("div");
      area.innerHTML = `<h1>${titulo}</h1><p>${document.getElementById("descricao").value}</p>`;
      passos.forEach((p, i) => {
        const img = p.querySelector("img");
        area.innerHTML += `
          <h3>Passo ${i + 1}</h3>
          <p>${p.querySelector("textarea").value}</p>
          ${img.src ? `<img src="${img.src}" style="max-width:100%; margin-bottom:15px;">` : ""}
        `;
      });

      html2pdf().from(area).save(`${titulo}.pdf`);
    }

    carregarListaInstrucoes();
  </script>
</body>
</html>
