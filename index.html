<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gráfico Empilhado com Percentuais</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    .input-group {
      width: 200px;
    }
    canvas {
      max-width: 100%;
    }
  </style>
</head>
<body>

<h2>Gráfico Empilhado: 2024 vs 2025 (Procedente)</h2>

<div class="container">
  <div class="input-group">
    <label for="valor2024">Valor 2024 (Jan):</label>
    <input type="number" id="valor2024" value="33" onchange="atualizarGrafico()">
  </div>
  <div class="input-group">
    <label for="valor2025">Valor 2025 (Jan):</label>
    <input type="number" id="valor2025" value="12" onchange="atualizarGrafico()">
  </div>
  <div class="input-group">
    <label for="valorProcedente">2025 Procedente (Jan):</label>
    <input type="number" id="valorProcedente" value="4" onchange="atualizarGrafico()">
  </div>
</div>

<canvas id="grafico"></canvas>

<script>
  const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

  let dados2024 = [33, 34, 35, 33, 22, 32, 37, 28, 29, 22, 14, 14];
  let dados2025 = [12, 14, 15, 0, 0, 0, 0, 0, 0, 0, 0, 0];
  let procedente2025 = [4, 8, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0];

  const ctx = document.getElementById('grafico').getContext('2d');

  const grafico = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: meses,
      datasets: [
        {
          label: '2024',
          data: dados2024,
          backgroundColor: 'skyblue',
          stack: '2024',
          datalabels: {
            color: 'white',
            anchor: 'end',
            align: 'start',
            formatter: Math.round
          }
        },
        {
          label: '2025',
          data: dados2025,
          backgroundColor: 'orange',
          stack: '2025',
          datalabels: {
            color: 'white',
            anchor: 'center',
            align: 'center',
            formatter: Math.round
          }
        },
        {
          label: '2025 Procedente',
          data: procedente2025,
          backgroundColor: 'green',
          stack: '2025',
          datalabels: {
            color: 'white',
            anchor: 'center',
            align: 'center',
            formatter: Math.round
          }
        },
        {
          label: '% sobre 2024',
          data: calcularPercentuais(dados2024, dados2025, procedente2025),
          type: 'bar',
          backgroundColor: 'transparent',
          stack: 'invisível',
          datalabels: {
            color: 'black',
            anchor: 'end',
            align: 'end',
            formatter: function(value) {
              return value > 0 ? value + '%' : '';
            },
            display: true
          }
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        datalabels: {
          display: true
        },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              return `${ctx.dataset.label}: ${ctx.raw}`;
            }
          }
        },
        legend: {
          position: 'top'
        }
      },
      scales: {
        x: { stacked: true },
        y: {
          beginAtZero: true,
          stacked: true
        }
      }
    },
    plugins: [ChartDataLabels]
  });

  function calcularPercentuais(base, parte1, parte2) {
    return base.map((val, i) => {
      const total = parte1[i] + parte2[i];
      return val > 0 ? Math.round((total / val) * 100) : 0;
    });
  }

  function atualizarGrafico() {
    const valor2024 = parseInt(document.getElementById('valor2024').value) || 0;
    const valor2025 = parseInt(document.getElementById('valor2025').value) || 0;
    const valorProcedente = parseInt(document.getElementById('valorProcedente').value) || 0;

    dados2024[0] = valor2024;
    dados2025[0] = valor2025;
    procedente2025[0] = valorProcedente;

    grafico.data.datasets[0].data = dados2024;
    grafico.data.datasets[1].data = dados2025;
    grafico.data.datasets[2].data = procedente2025;
    grafico.data.datasets[3].data = calcularPercentuais(dados2024, dados2025, procedente2025);

    grafico.update();
  }
</script>

</body>
</html>
